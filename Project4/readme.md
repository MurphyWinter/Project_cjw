# Do your best to optimize SM3 implementation

## å‰è¨€ã€é¡¹ç›®è¯´æ˜

åŸºäºä¸ªäººå®ç°çš„SM3è¿›è¡Œè½¯ä»¶ä¼˜åŒ–ï¼Œä¸»è¦è¿ç”¨äº†å¾ªç¯å±•å¼€å’Œå‡å°‘å‡½æ•°çš„è°ƒç”¨æ¥è¿›è¡Œä¼˜åŒ–

## ä¸€ã€SM3ä»‹ç»

### SM3æ¦‚è¿°

- MDç»“æ„ï¼Œé•¿åº¦å°äº2<sup>64</sup>bitçš„æ¶ˆæ¯
- æ¶ˆæ¯åˆ†ç»„ä¸º512-bitï¼Œä¸­é—´é“¾æ¥å˜é‡ä¸º256-bitï¼Œæ‚å‡‘å€¼ä¸º256-bit
- å‹ç¼©å‡½æ•°å…±64æ­¥æ“ä½œ
- å¸ƒå°”å‡½æ•°ï¼š



![01](01.png)

- ç½®æ¢å‡½æ•°ï¼š

![02](02.png)

### æ¶ˆæ¯å¡«å……ç®—æ³•
SM3æ•°æ®å¡«å……è§„åˆ™å’ŒSHA256ä¸€æ ·ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

1. å…ˆå¡«å……ä¸€ä¸ªâ€œ1â€ï¼Œåé¢åŠ ä¸Škä¸ªâ€œ0â€ã€‚å…¶ä¸­kæ˜¯æ»¡è¶³(n+1+k) mod 512 = 448çš„æœ€å°æ­£æ•´æ•°ã€‚
2. è¿½åŠ 64ä½çš„æ•°æ®é•¿åº¦ï¼ˆbitä¸ºå•ä½ï¼Œå¤§ç«¯åºå­˜æ”¾ã€‚è§‚å¯Ÿç®—æ³•æ ‡å‡†åŸæ–‡é™„å½•Aè¿ç®—ç¤ºä¾‹å¯ä»¥æ¨çŸ¥ã€‚ï¼‰

![03](03.png)

### æ¶ˆæ¯æ‰©å±•ç®—æ³•
è®°ç¬¬iä¸ª512æ¯”ç‰¹çš„æ¶ˆæ¯åˆ†ç»„ä¸ºğ‘€<sub>0</sub><sup>ğ‘–</sup>,...,ğ‘€<sub>15</sub><sup>ğ‘–</sup>ã€‚æŒ‰å¦‚ä¸‹æ­¥éª¤ç”Ÿæˆ132ä¸ª32æ¯”ç‰¹çš„æ¶ˆæ¯å­—ï¼š

> - For t=0 to 15
>
>   ğ‘Š<sub>t</sub> = ğ‘€<sub>t</sub><sup>ğ‘–</sup>
>
> - For t=16 to 67
>
>   ğ‘Š<sub>t</sub> = ğ‘ƒ<sub>1</sub>(ğ‘Š<sub>t-16</sub>â¨ğ‘Š<sub>t-9</sub>â¨(ğ‘Š<sub>t-3</sub>â‹˜15))â¨(ğ‘Š<sub>t-1</sub>â‹˜7)â¨ğ‘Š<sub>t-6</sub>
>
> - For t=0 to 63
>
>   ğ‘Š<sub>t</sub><sup>'</sup>=ğ‘Š<sub>t</sub> â¨ğ‘Š<sub>t+4</sub>

![04](04.png)

### å‹ç¼©å‡½æ•°
åˆå§‹IVæ˜¯å›ºå®šçš„å¸¸æ•°

![05](05.png)

![06](06.png)

#### è¿­ä»£å‹ç¼©

![07](07.png)

## äºŒã€å…·ä½“å®ç°

### ä¼˜åŒ–å‰originalæ–‡ä»¶å®ç°

#### å®šä¹‰å¸¸é‡ã€å®

ä»£ç åŠŸèƒ½ï¼š

> - å®šä¹‰äº†8ä¸ª32ä½æ— ç¬¦å·æ•´æ•°çš„æ•°ç»„ `IV` ä½œä¸ºåˆå§‹å‘é‡ã€‚
> - å®šä¹‰äº†64ä¸ª32ä½æ— ç¬¦å·æ•´æ•°çš„æ•°ç»„ `T`ï¼Œè¿™æ˜¯SM3ç®—æ³•ä¸­çš„å¸¸é‡è¡¨ï¼Œç”¨äºè¿­ä»£è®¡ç®—ä¸­ã€‚
> - å®šä¹‰äº†8ä¸ªå®ï¼Œåˆ†åˆ«ç”¨äºè¡¨ç¤ºSM3ç®—æ³•ä¸­çš„8ä¸ªå¯„å­˜å™¨ `a` åˆ° `h` çš„ç´¢å¼•ã€‚

#### åˆå§‹åŒ–å¸¸é‡è¡¨

ä»£ç åŠŸèƒ½ï¼š

> åœ¨ `_init_T()` å‡½æ•°ä¸­å¯¹ `T` æ•°ç»„è¿›è¡Œåˆå§‹åŒ–

#### å¾ªç¯å·¦ç§»å®ç°

ä»£ç åŠŸèƒ½ï¼š

> åœ¨ `ROTL()` å‡½æ•°ä¸­å®ç°å¯¹32ä½æ•´æ•°çš„å¾ªç¯å·¦ç§»

ä»£ç å±•ç¤ºï¼š

```c++
/* å¾ªç¯å·¦ç§»ï¼Œå¯¹intç±»å‹å˜é‡Xå¾ªç¯å·¦ç§»nä½ */
int ROTL(int X, int n)
{
	return (((X << n) & 0xffffffff) | ((X & 0xffffffff) >> (32 - n)));
}
```

#### å¸ƒå°”å‡½æ•°

ä»£ç åŠŸèƒ½ï¼š

> `FF()` å’Œ `GG()` å‡½æ•°æ˜¯SM3ç®—æ³•ä¸­çš„ä¸¤ç§å¸ƒå°”å‡½æ•°ï¼Œç”¨äºå‹ç¼©å‡½æ•°çš„è¿­ä»£è¿‡ç¨‹ä¸­

ä»£ç å±•ç¤ºï¼š

```c++
/* å¸ƒå°”å‡½æ•° */
int FF(int X, int Y, int Z, int j) 
{
	if (j < 16 && j >= 0)
		return(X ^ Y ^ Z);
	if (j > 15 && j < 64)
		return((X & Y) | (X & Z) | (Y & Z));
	return false;
}

int GG(int X, int Y, int Z, int j) 
{
	if (j < 16 && j >= 0)
		return(X ^ Y ^ Z);
	if (j > 15 && j < 64)
		return ((X & Y) | ((~X) & Z));
	return false;
}
```

#### å‹ç¼©å‡½æ•°

ä»£ç åŠŸèƒ½ï¼š

> `CF()` å‡½æ•°æ˜¯SM3ç®—æ³•çš„æ ¸å¿ƒå‹ç¼©å‡½æ•°ï¼š
>
> 1. å°†8ä¸ª32ä½æ— ç¬¦å·æ•´æ•°ï¼ˆå¯„å­˜å™¨ï¼‰ä½œä¸ºè¾“å…¥
> 2. æŒ‰ç…§SM3ç®—æ³•çš„è¿­ä»£è®¡ç®—è§„åˆ™è¿›è¡Œä¸€è½®å‹ç¼©
> 3. å‹ç¼©å‡½æ•°å°†è¾“å…¥çš„æ¶ˆæ¯åˆ†ç»„è¿›è¡Œæ‰©å±•ï¼ˆæ¶ˆæ¯æ‹“å±•ï¼‰
> 4. è¿›è¡Œ64è½®è¿­ä»£ï¼Œæœ€ç»ˆå¾—åˆ°8ä¸ªæ›´æ–°åçš„å¯„å­˜å™¨å€¼

ä»£ç å±•ç¤ºï¼š

```c++
/* å‹ç¼©å‡½æ•° */
void CF(int* v, int* B)
{
	int W68[68] = { 0 };
	int W64[64] = { 0 };
	int V[8] = { 0 };
	for (int i = 0; i < 8; i++)
		V[i] = v[i];
	/* æ¶ˆæ¯æ‹“å±• */
	int j = 0;
	for (; j < 16; j++) 
	{
		W68[j] = B[j];
	}
	for (; j <= 67; j++) 
	{
		int w0 = W68[j - 16] ^ W68[j - 9] ^ ROTL(W68[j - 3], 15);
		W68[j] = w0 ^ ROTL(w0, 15) ^ ROTL(w0, 23) ^ ROTL(W68[j - 13], 7) ^ W68[j - 6];
	}
	for (int i = 0; i < 64; i++) 
	{
		W64[i] = W68[i] ^ W68[i + 4];
	}
	/* å‹ç¼©å‡½æ•° */
	int SS1 = 0, SS2 = 0, TT1 = 0, TT2 = 0;
	for (int j = 0; j < 64; j++) 
	{
		SS1 = ROTL(ROTL(V[a], 12) + V[e] + ROTL(T[j], j), 7);
		SS2 = SS1 ^ (((V[a] << 12) & 0xffffffff) | ((V[a] & 0xffffffff) >> (32 - 12)));
		TT1 = FF(V[a], V[b], V[c], j) + V[d] + SS2 + W64[j];
		TT2 = GG(V[e], V[f], V[g], j) + V[h] + SS1 + W68[j];
		V[d] = V[c];
		V[c] = ((V[b] << 9) & 0xffffffff) | ((V[b] & 0xffffffff) >> (32 - 9));
		V[b] = V[a];
		V[a] = TT1;
		V[h] = V[g];
		V[g] = ((V[f] << 19) & 0xffffffff) | ((V[f] & 0xffffffff) >> (32 - 19));
		V[f] = V[e];
		V[e] = TT2 ^ ROTL(TT2, 9) ^ ROTL(TT2, 17);
	}

	for (int i = 0; i < 8; i++)
		v[i] ^= V[i];
}
```

#### å“ˆå¸Œå‡½æ•°

ä»£ç åŠŸèƒ½ï¼š

> `SM3()`æ˜¯SM3ç®—æ³•çš„å…¥å£å‡½æ•°ï¼Œç”¨äºè¿›è¡Œæ¶ˆæ¯çš„å“ˆå¸Œè®¡ç®—ï¼š
>
> 1. å¯¹è¾“å…¥æ¶ˆæ¯è¿›è¡Œå¡«å……
> 2. æŒ‰ç…§512ä½ï¼ˆ64å­—èŠ‚ï¼‰ä¸€ç»„è¿›è¡Œåˆ†ç»„
> 3. è°ƒç”¨å‹ç¼©å‡½æ•°å¯¹æ¯ä¸ªåˆ†ç»„è¿›è¡Œè¿­ä»£å‹ç¼©
> 4. å¾—åˆ°8ä¸ª32ä½æ— ç¬¦å·æ•´æ•°ä½œä¸ºå“ˆå¸Œç»“æœ

ä»£ç å±•ç¤ºï¼š

```c++
/* å“ˆå¸Œå‡½æ•°ï¼Œè¾“å…¥è¾“å‡ºå‡ä¸ºæ¯ä¸ªå…ƒç´ 4å­—èŠ‚çš„intç±»å‹æ•°ç»„ï¼Œsizeä¸ºå­—èŠ‚æ•° */
void SM3(int* input, int* output, ll size)
{
	//å¡«å……
	ll n = size / 64;
	ll k = size % 64;
	size *= 8;	//æ€»bitæ•°
	/* 512bitï¼Œå³16ä¸ªå­—ä¸ºä¸€ç»„B[i]ï¼Œä¸€å…±16 * (n + 1)ä¸ªå…ƒç´ ï¼Œå³n+1ç»„ */
	int* B = new int[16 * (n + 1)];
	int i = 0;
	int x = 16 * n;
	for (; i < x; i++) 
	{
		B[i] = input[i];
	}
	x += k / 4;
	for (; i < x; i++)
		B[i] = input[i];
	if (k % 4 == 0)
		B[i] = 0x80000000;
	else
		B[i] = input[i] | (0x80 << ((3 - (k % 4)) * 8));
	++i;
	//å¾ªç¯å±•å¼€
	x = 16 * n + 14;
	for (; i < x; i++) 
	{
		B[i] = 0;
	}
	B[16 * n + 15] = size;
	B[16 * n + 14] = size >> 32;
	n++;
	//iterate(B, output, n);
	for (int j = 0; j < 8; j++)
	{
		output[j] = IV[j];
	}
	for (int i = 0; i < n; i++)
		CF(output, (B + (i * 16)));
}
```

#### æµ‹è¯•å‡½æ•°

ä»£ç åŠŸèƒ½ï¼š

> `test()`ä½¿ç”¨é¢„è®¾çš„æµ‹è¯•æ•°æ® `MESS`ï¼š
>
> 1. å°†æµ‹è¯•æ•°æ®è½¬æ¢æˆ32ä½æ•´æ•°çš„æ•°ç»„ `B`
> 1. è°ƒç”¨ `SM3()` å‡½æ•°è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œå¹¶è¾“å‡ºç»“æœ

ä»£ç å±•ç¤ºï¼š

> ```c++
> /* æµ‹è¯•å‡½æ•° */
> void test() 
> {
>    _init_T();
>    //é¦–å…ˆæŠŠä¸€ä¸ªå…ƒç´ ä¸€ä¸ªå­—èŠ‚çš„æ•°ç»„MESS(å­—ç¬¦ä¸²)ï¼Œå˜ä¸ºä¸€ä¸ªå…ƒç´ ä¸€ä¸ªå­—çš„æ•°ç»„B(int)
>    ll size = sizeof(MESS) / sizeof(int);  //sizeä¸ºæ‰€å çš„å­—èŠ‚æ•°
>    int V[8] = { 0 };
>    int* B = new int[size / 4 + (bool)(size % 4)];
>    int i = 0;
>    for (; i < size / 4; i++)
>       B[i] = MESS[i * 4] << 24 | MESS[i * 4 + 1] << 16 | MESS[i * 4 + 2] << 8 | MESS[i * 4 + 3];
>    if (size % 4) 
>    {
>       B[i] = 0;
>       for (int k = 0; k < size % 4; k++)
>          B[i] = B[i] | (MESS[i * 4 + k] << (8 * (3 - k)));
>    }
>    //ç„¶åå°†Bä½œä¸ºSM3çš„è¾“å…¥
>    SM3(B, V, size);
>    cout << hex;
>    for (int i = 0; i < 8; i++)
>       cout << V[i] << ' ';
> }
> ```

#### ä¸»å‡½æ•°

ä»£ç åŠŸèƒ½ï¼š

> åœ¨ `main()` å‡½æ•°ä¸­è°ƒç”¨ `test()` å‡½æ•°å¹¶è®¡ç®—è¿è¡Œæ—¶é—´ï¼Œè¾“å‡ºå“ˆå¸Œç»“æœå’Œè¿è¡Œè€—æ—¶

ä»£ç å±•ç¤ºï¼š

```c++
int main()
{
	std::chrono::time_point<std::chrono::steady_clock> start = std::chrono::steady_clock::now();
	test();
	std::chrono::time_point<std::chrono::steady_clock> end = std::chrono::steady_clock::now();
	std::chrono::duration<double> elapsed = end - start;
	cout << "\nè€—æ—¶\n" << elapsed.count() << "s";
	return 0;
}
```

### ä¼˜åŒ–åoptimizationæ–‡ä»¶å®ç°

ç›¸è¾ƒäºåŸºæœ¬çš„SM3å®ç°ï¼ˆoriginalæ–‡ä»¶ï¼‰ï¼Œæœ¬æ–‡ä»¶åšå‡ºäº†ä»¥ä¸‹å‡ æ–¹é¢çš„ä¼˜åŒ–ï¼š

#### ä½¿ç”¨Loop Unrollingå¾ªç¯å±•å¼€ä¼˜åŒ–

##### `_init_T()` å‡½æ•°ï¼š

åŸå…ˆçš„ `_init_T()` å‡½æ•°æ˜¯ç”¨ä¸€ä¸ªå¾ªç¯åˆ†åˆ«ç»™å¸¸é‡è¡¨ `T` çš„å‰16ä¸ªå…ƒç´ å’Œå48ä¸ªå…ƒç´ èµ‹å€¼ã€‚å¾ªç¯å±•å¼€ä¼˜åŒ–åï¼Œå°†åŸæœ¬çš„å¾ªç¯æ‹†åˆ†æˆä¸¤ä¸ªå¾ªç¯ï¼Œåˆ†åˆ«ä¸ºå‰16ä¸ªå…ƒç´ å’Œå48ä¸ªå…ƒç´ è¿›è¡Œèµ‹å€¼ï¼Œæ¯æ¬¡å¾ªç¯ç»™4ä¸ªå…ƒç´ èµ‹ç›¸åŒçš„å€¼ï¼Œä»è€Œæé«˜äº†èµ‹å€¼çš„æ•ˆç‡ã€‚

```c++
void _init_T()
{
    int i = 0;
    for (; i < 16; i += 4)
    {
        T[i] = 0x79CC4519;
        T[i + 1] = 0x79CC4519;
        T[i + 2] = 0x79CC4519;
        T[i + 3] = 0x79CC4519;
    }

    for (; i < 64; i += 4)
    {
        T[i] = 0x7A879D8A;
        T[i + 1] = 0x7A879D8A;
        T[i + 2] = 0x7A879D8A;
        T[i + 3] = 0x7A879D8A;
    }
}
```

##### `CF()` å‡½æ•°ï¼š

åœ¨ `CF()` å‡½æ•°ä¸­ï¼Œå¯¹æ¶ˆæ¯è¿›è¡Œæ‹“å±•å’Œå‹ç¼©æ—¶ï¼ŒåŸæœ¬æœ‰ä¸¤ä¸ªå¾ªç¯ç”¨äºåˆ†åˆ«èµ‹å€¼ `W68` å’Œ `W64` æ•°ç»„çš„å…ƒç´ ã€‚å¾ªç¯å±•å¼€ä¼˜åŒ–åï¼Œå°†è¿™ä¸¤ä¸ªå¾ªç¯åˆ†åˆ«æ‹†åˆ†æˆå››ä¸ªå¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯ç»™4ä¸ªå…ƒç´ èµ‹å€¼ï¼Œä»è€Œæé«˜äº†èµ‹å€¼çš„æ•ˆç‡ã€‚

```c++
void CF(int* v, int* B)
{
    int W68[68] = { 0 };
    int W64[64] = { 0 };
    int V[8] = { 0 };
    V[0] = v[0];
    V[1] = v[1];
    V[2] = v[2];
    V[3] = v[3];
    V[4] = v[4];
    V[5] = v[5];
    V[6] = v[6];
    V[7] = v[7];

    int j = 0;
    for (; j < 16; j += 4)
    {
        W68[j] = B[j];
        W68[j + 1] = B[j + 1];
        W68[j + 2] = B[j + 2];
        W68[j + 3] = B[j + 3];
    }
    for (; j <= 67; j++)
    {
        int w0 = W68[j - 16] ^ W68[j - 9] ^ ROTL(W68[j - 3], 15);
        W68[j] = w0 ^ ROTL(w0, 15) ^ ROTL(w0, 23) ^ ROTL(W68[j - 13], 7) ^ W68[j - 6];
    }
    for (int i = 0; i < 64; i += 4)
    {
        W64[i] = W68[i] ^ W68[i + 4];
        W64[i + 1] = W68[i + 1] ^ W68[i + 4 + 1];
        W64[i + 2] = W68[i + 2] ^ W68[i + 4 + 2];
        W64[i + 3] = W68[i + 3] ^ W68[i + 4 + 3];
    }
    // å‹ç¼©å‡½æ•°
    // ...
}

```

#### ä½¿ç”¨äº†ç§»ä½ç­‰æ“ä½œä»£æ›¿ä¹˜é™¤æ¨¡

##### `test()`å‡½æ•°ï¼š

åœ¨æ¯æ¬¡å¾ªç¯ä¸­ï¼Œé€šè¿‡ä½ç§»å’ŒæŒ‰ä½æˆ–è¿ç®—ï¼Œå°† `MESS` ä¸­çš„å››ä¸ªå­—èŠ‚æŒ‰ç…§å¤§ç«¯åºç»„åˆæˆä¸€ä¸ªæ•´å‹æ•°ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨æ•°ç»„ `B` ä¸­

```C++
for (; i < size / 4; i++)
		B[i] = MESS[i * 4] << 24 | MESS[i * 4 + 1] << 16 | MESS[i * 4 + 2] << 8 | MESS[i * 4 + 3];
	if (size % 4)
	{
		B[i] = 0;
		for (int k = 0; k < size % 4; k++)
			B[i] = B[i] | (MESS[i * 4 + k] << (8 * (3 - k)));
	}
```

#####`_init_T()` å‡½æ•°ï¼š

`_init_T()`å‡½æ•°ä¸­åˆå§‹åŒ–Tæ•°ç»„çš„éƒ¨åˆ†ï¼ŒåŸä»£ç ä¸­ä½¿ç”¨äº†ä¸¤æ¬¡å¾ªç¯åˆ†åˆ«ç»™Tçš„å‰16å’Œå48ä¸ªå…ƒç´ èµ‹å€¼ï¼Œä¼˜åŒ–åçš„ä»£ç å°†è¿™ä¸¤æ¬¡å¾ªç¯åˆå¹¶ï¼Œå¹¶ç”¨ç§»ä½æ“ä½œä»£æ›¿ä¹˜æ³•ï¼Œä»è€Œæé«˜äº†æ•ˆç‡ã€‚

```c++
void _init_T()
{
	int i = 0;
	for (; i < 16; i += 4)
	{
		T[i] = 0x79CC4519;
		T[i + 1] = 0x79CC4519;
		T[i + 2] = 0x79CC4519;
		T[i + 3] = 0x79CC4519;
	}

	for (; i < 64; i += 4)
	{
		T[i] = 0x7A879D8A;
		T[i + 1] = 0x7A879D8A;
		T[i + 2] = 0x7A879D8A;
		T[i + 3] = 0x7A879D8A;
	}
}
```

##### `FF`å‡½æ•°å’Œ`GG`å‡½æ•°ï¼š

ä½¿ç”¨äº†æ›´ç®€æ´çš„æ–¹å¼è¿›è¡Œ`FF`å‡½æ•°å’Œ`GG`å‡½æ•°ä¸­çš„å¸ƒå°”é€»è¾‘éƒ¨åˆ†ï¼Œå¹¶ç”¨ç§»ä½æ“ä½œæ¥ä»£æ›¿ä¹˜æ³•ã€‚

```c++
int FF(int X, int Y, int Z, int j)
{
	if (j < 16 && j >= 0)
		return X ^ Y ^ Z;
	if (j > 15 && j < 64)
		return (X & Y) | (X & Z) | (Y & Z);
	return false;
}

int GG(int X, int Y, int Z, int j)
{
	if (j < 16 && j >= 0)
		return X ^ Y ^ Z;
	if (j > 15 && j < 64)
		return X & Y | ~X & Z;
	return false;
}
```

### ä½¿ç”¨opensslåº“æ–‡ä»¶å®ç°

#### ä»£ç åŠŸèƒ½

1. å°†æ•´å‹æ•°ç»„ `MESS` å¼ºåˆ¶è½¬æ¢ä¸º `unsigned char*` ç±»å‹ï¼Œä»¥ä¾¿åç»­å“ˆå¸Œè®¡ç®—ä½¿ç”¨ã€‚
2. åˆ›å»ºäº†ä¸€ä¸ªç”¨äºå­˜å‚¨å“ˆå¸Œç»“æœçš„æ•°ç»„ `digest`ï¼Œé•¿åº¦ä¸º `SM3_DIGEST_LENGTH`ï¼Œå³ 32 å­—èŠ‚ã€‚
3. åˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘ `EVP_MD_CTX` ç»“æ„ä½“çš„æŒ‡é’ˆ `mdctx`ï¼Œè¯¥ç»“æ„ä½“ç”¨äºè®¡ç®—å“ˆå¸Œå€¼ã€‚
4. è·å–äº† SM3 å“ˆå¸Œç®—æ³•çš„ EVPï¼ˆEVP_MDï¼‰å¯¹è±¡ï¼Œå¹¶å°†å…¶æŒ‡é’ˆä¿å­˜åœ¨ `md` ä¸­ã€‚
5. åˆå§‹åŒ–å“ˆå¸Œè®¡ç®—ä¸Šä¸‹æ–‡ `mdctx`ï¼Œå°†å…¶å’Œé€‰å®šçš„å“ˆå¸Œç®—æ³• `md` å…³è”ã€‚
6. æ›´æ–°å“ˆå¸Œè®¡ç®—ä¸Šä¸‹æ–‡ï¼Œå°†æ•°æ® `message`ï¼ˆå³ `MESS` æ•°ç»„è½¬æ¢åçš„æ•°æ®ï¼‰çº³å…¥è®¡ç®—ã€‚
7. å®Œæˆå“ˆå¸Œè®¡ç®—ï¼Œå¹¶å°†ç»“æœä¿å­˜åœ¨ `digest` ä¸­ï¼ŒåŒæ—¶è·å–è®¡ç®—å¾—åˆ°çš„å“ˆå¸Œå€¼é•¿åº¦ `digest_len`ã€‚
8. è¾“å‡ºå“ˆå¸Œè®¡ç®—è€—æ—¶ã€‚
9. é‡Šæ”¾å“ˆå¸Œè®¡ç®—ä¸Šä¸‹æ–‡ã€‚

## ä¸‰ã€å®ç°æ•ˆæœ

### è¿è¡Œæ–¹å¼

è¿è¡Œæ–¹å¼:å…¨å±€å˜é‡MESSä¸ºéœ€è¦hashçš„ä¿¡æ¯ï¼Œä¸€ä¸ªå…ƒç´ ä¸€ä¸ªå­—èŠ‚ï¼Œintå˜é‡

### ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

#### ä¼˜åŒ–å‰

![08](08.png)

#### ä¼˜åŒ–å

![09](09.png)

#### ä½¿ç”¨OpenSSLåº“

![10](10.png)

#### å›¾è¡¨å±•ç¤º

æœ€åç”¨å›¾åƒæ¥è¡¨ç¤ºæ›´ä¸ºç›´è§‚ä¸€äº›ï¼š

![11](11.png)

## å››ã€å‚è€ƒ

1. https://blog.csdn.net/qq_40662424/article/details/121637732
2. https://zhuanlan.zhihu.com/p/129692191
3. PPTï¼š20230330-sm3-public
